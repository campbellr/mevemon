/* Lumebox $ plugin
 * Copyright Anders Zakrisson/Sogeti 2009-2010
 * http://anders.zakrisson.se, http://www.sogeti.se
 * This software is released under the GPL License.
 */

(function(a){function h(){this.media=this.id=this.published=this.snippet=this.content=this.link=this.title=null}function l(){this.version=this.description=this.link=this.title=null;this.items=[]}a.lumebox={loader:function(d){d.feedApiKey!=undefined?a.getScript("http://www.google.com/jsapi?key"+d.feedApiKey,function(){google.load("feeds","1",{nocss:true,callback:function(){a.lumebox.init(d)}})}):a.lumebox.init(d)},settings:{showAsList:false,rss:[],proxy:"",duration:"slow",rssWidth:680,opacity:"0.7",
loop:true,scrollToTop:false,autoNext:false,parentElementId:false,useParentOffset:true,useGestures:true,graphicsDir:"ui/",feedApiKey:false,platformMode:"auto"},data:{lumeboxItems:new l,lumeboxFeeds:{},popupStatus:0,group:null,timeoutId:null,index:1},init:function(d){d?a.lumebox.settings=a.extend({},a.lumebox.settings,d):d={};if(a.lumebox.settings.platformMode=="auto"&&(navigator.platform.indexOf("iPhone")!=-1||navigator.platform.indexOf("iPod")!=-1||navigator.userAgent.indexOf("iPad")!=-1||navigator.userAgent.indexOf("Android")!=
-1))a.lumebox.settings.platformMode="mobile";(this.settings.parentElementId?a("#"+this.settings.parentElementId):a("body").eq(0)).append('<div id="lumebox-popup"><div id="lumebox-topmenu"><a href="#" id="lumebox-close" class="lumebox-controls"><img src="'+a.lumebox.settings.graphicsDir+'icon_close.png"></a></div><div id="lumebox-content"></div></div><div id="lumebox-bg"></div>');a("#lumebox-close").click(function(){a.lumebox.close()});a("#lumebox-bg").click(function(){a.lumebox.close()});a("#lumebox-content").quickGestures({clickLeft:function(){a.lumebox.previous()},
clickRight:function(){a.lumebox.next()}});a(document).keydown(function(c){if(a.lumebox.data.popupStatus==1){switch(c.keyCode){case 27:a.lumebox.close();break;case 39:a.lumebox.next();break;case 78:a.lumebox.next();break;case 37:a.lumebox.previous();break;case 80:a.lumebox.previous()}switch(c.charCode){case 110:a.lumebox.next();break;case 112:a.lumebox.previous()}}});a(window).bind("resize",function(){a.lumebox.resize()});var b;a("a[rel^=lightbox]").each(function(){var c=this.rel.match(/\[([a-zA-Z0-9\-]*)\]/i);
if((c=c?c[1]:null)&&a.lumebox.data.lumeboxFeeds[c])b=a.lumebox.data.lumeboxFeeds[c];else if(c){b=new l;b.title=c;a.lumebox.data.lumeboxFeeds[c]=b}if(this.href.search(/(\.jpg|\.jpeg|\.gif|\.png)$/i)!=-1){var f,e=new h;e.content=this.title;e.link=this.href;f=c?a.lumebox.data.lumeboxFeeds[c].items.push(e)-1:a.lumebox.data.lumeboxItems.items.push(e)-1;e.id=c+"-"+f;a(this).click(function(){a.lumebox.open({index:f,group:c});return false})}else if(a.lumebox.settings.feedApiKey!=false&&this.rel.search(/lightbox\[(rss[a-zA-Z0-9\-]*)\]/i)!=
-1){var g=this;a.lumebox.parseFeed({url:a.lumebox.settings.proxy+this.href,success:function(i){a.each(i.items,function(k,j){e=a.extend({},e,j);c?a.lumebox.data.lumeboxFeeds[c].items.push(e):a.lumebox.data.lumeboxItems.items.push(e)});a(g).click(function(){a.lumebox.open({index:null,group:c});return false})}})}});a.each(a.lumebox.settings.rss,function(c,f){a.lumebox.parseFeed({url:a.lumebox.settings.proxy+f,success:function(e){a.each(e.items,function(g,i){var k=a.extend({},k,i);a.lumebox.data.lumeboxItems.items.push(k)})}})});
return this},resize:function(d){if(a.lumebox.data.popupStatus==1){var b=a(window).width(),c=a(window).height(),f=a("#lumebox-content").find("img.lumebox-img").attr("src")?a("#lumebox-content").find("img.lumebox-img").eq(0):false,e=f?f.attr("width"):b;if(f){var g=f.attr("width")/f.attr("height");if(e>b){f.attr("width",b);f.attr("height",b/g)}else f.attr("width");if(f.outerHeight(true)+a("#lumebox-caption").outerHeight(true)>c){e=c-a("#lumebox-caption").outerHeight(true);f.attr("height",e);f.attr("width",
e*g);e=f.outerHeight(true)*g}else e=f.attr("width")}else e=a.lumebox.settings.rssWidth;if(e<1)e=b;a("#lumebox-bg").css({height:c});a("#lumebox-popup").css({width:e,left:(b-e)/2-(a.lumebox.settings.useParentOffset?a("body").offset().left:0)});b=a("#lumebox-content").outerHeight(true)+a("#lumebox-footer").outerHeight(true);a("#lumebox-popup").css({height:b,top:a(window).scrollTop()+(b>c?0:c/2-b/2)});a.lumebox.settings.scrollToTop&&a(this).scrollTop(0);a.isFunction(d)&&d()}},open:function(d){d||(d={});
a.lumebox.data.group=d.group?d.group:null;var b=d.group?a.lumebox.data.lumeboxFeeds[d.group]:a.lumebox.data.lumeboxItems;a.lumebox.data.index=d.index?d.index:0;var c;c=a.lumebox.settings.showAsList?b.items:[b.items[a.lumebox.data.index]];if(a.lumebox.data.popupStatus==0){a("#lumebox-bg").css({opacity:a.lumebox.settings.opacity});a("#lumebox-bg").fadeIn("fast",function(){a("#lumebox-popup").css("opacity",0).show();a.lumebox.data.popupStatus=1;a.lumebox.switchPost(c,function(){if(a.lumebox.settings.autoNext&&
!isNaN(a.lumebox.settings.autoNext)&&!a.lumebox.settings.showAsList)a.lumebox.data.timeoutId=setInterval("$.lumebox.next()",a.lumebox.settings.autoNext)})})}},close:function(){if(a.lumebox.data.popupStatus==1){a("#lumebox-bg").fadeOut(a.lumebox.settings.duration);a("#lumebox-popup").fadeOut(a.lumebox.settings.duration);a.lumebox.data.popupStatus=0}clearInterval(a.lumebox.data.timeoutId)},next:function(){var d=a.lumebox.data.group?a.lumebox.data.lumeboxFeeds[a.lumebox.data.group]:a.lumebox.data.lumeboxItems;
a.lumebox.data.index=a.lumebox.data.index<d.items.length-1?a.lumebox.data.index+1:0;a.lumebox.switchPost([d.items[a.lumebox.data.index]],"next",d)},previous:function(){var d=a.lumebox.data.group?a.lumebox.data.lumeboxFeeds[a.lumebox.data.group]:a.lumebox.data.lumeboxItems;a.lumebox.data.index=a.lumebox.data.index>0?a.lumebox.data.index-1:d.items.length-1;a.lumebox.switchPost([d.items[a.lumebox.data.index]],"previous",d)},switchPost:function(d,b,c){if(a.lumebox.data.popupStatus==1){var f={opacity:0};
if(b!=undefined)if(b=="next")f={left:-a("#lumebox-popup").width()};else if(b=="previous")f={left:a(window).width()};a("#lumebox-popup").animate(f,a.lumebox.settings.duration,function(){a("#lumebox-popup").css({opacity:0});a("#lumebox-content").css("opacity",0).lboxFillContent(d,function(){a("#lumebox-popup").css("opacity",1);a.lumebox.resize(function(){a("#lumebox-popup").children(":not(.lumebox-controls)").animate({opacity:1},a.lumebox.settings.duration);a.isFunction(c)&&c()})})})}},parseFeed:function(d){d.url.search(/^http/i)!=
-1&&(new google.feeds.Feed(d.url)).load(function(b){var c=new l;c.title=b.feed.title;c.link=b.feed.link;c.description=b.feed.description;c.version=b.feed.type;a(b.feed.entries).each(function(f,e){var g=new h;g.title=e.title;g.link=e.link;g.published=e.publishedDate;g.id=e.link;g.content=e.content;g.snippet=e.contentSnippet;c.items.push(g)});a.isFunction(d.success)&&d.success(c)})},loadImage:function(d,b){a("#lboxItem-"+d.id).length<1&&a("<img />").attr("src",d.link).load(b);a("#lumebox-bg").find(".lumebox-preLoaded").length>
50&&a("#lumebox-bg").find(".lumebox-preLoaded").eq(0).remove();var c=a.lumebox.data.group?a.lumebox.data.lumeboxFeeds[a.lumebox.data.group]:a.lumebox.data.lumeboxItems,f=c.items[a.lumebox.data.index<c.items.length-1?a.lumebox.data.index+1:0];a("#lboxItem-"+f.id).length<1&&a("<img />").attr("src",f.link).load(function(){a(this).attr({"class":"lumebox-preLoaded",id:"lboxItem-"+f.id,width:this.width,height:this.height}).appendTo("#lumebox-bg")})}};a.fn.lboxFillContent=function(d,b){return this.each(function(){var c=
this;if(d.length==1&&d[0].link.search(/(\.jpg|\.jpeg|\.gif|\.png)$/i)!=-1){h=d[0];if(a("#lboxItem-"+h.id).length>0){a.lumebox.loadImage(h);a(c).html(a("#lboxItem-"+h.id).clone().attr("class","lumebox-img"));a(c).find("img.lumebox-img").wrap('<div class="post"><div class="post-body"></div></div>');h.content&&a(c).find("div.post-body").append('<div id="lumebox-caption">'+h.content+"</div>");a.isFunction(b)&&b()}else a.lumebox.loadImage(h,function(){a(this).attr({"class":"lumebox-img",width:this.width,
height:this.height});a(c).html(this).find("img.lumebox-img").wrap('<div class="post"><div class="post-body"></div></div>');h.content&&a(c).find("div.post-body").append('<div id="lumebox-caption">'+h.content+"</div>");a.isFunction(b)&&b()})}else{html="";a.each(d,function(f,e){var g="",i="";if(e.title)g='<div class="post-title"><h2><a href="'+e.link+'">'+e.title+"</a></h2></div>";i=e.content;html+='<div class="post hentry">'+g+'<div class="post-body>">'+i+"</div></div>"});a(c).html(html);a.isFunction(b)&&
b()}})};a.fn.quickGestures=function(d){settings=a.extend({dragLeft:null,dragRight:null,clickLeft:null,clickRight:null,tap:null,hold:null,holdTime:800,threshold:50,mobile:false},d);this.each(function(){var b={x:0,y:0,t:null,time:null};if(settings.mobile){var c,f,e;this.addEventListener("touchstart",function(g){g.preventDefault();f=(a(window).width()-a(this).outerWidth(true))/2;e=(a(window).height()-a(this).outerHeight(true))/2;b.x=g.targetTouches[0].pageX-f;b.y=g.targetTouches[0].pageY-e;b.time=new Date;
if(a.isFunction(settings.hold))b.t=setTimeout("settings.hold()",settings.holdTime)},false);this.addEventListener("touchmove",function(g){g.preventDefault();c=g.targetTouches[0].pageX-f},false);this.addEventListener("touchend",function(g){g.preventDefault();g=c-f-b.x;b.t!=null&&clearTimeout(b.t);if(g<=-settings.threshold)a.isFunction(settings.dragLeft)&&settings.dragLeft();else g>=settings.threshold&&a.isFunction(settings.dragRight)&&settings.dragRight()},false)}else a(this).mousedown(function(g){var i=
(a(window).width()-a(this).outerWidth(true))/2,k=(a(window).height()-a(this).outerHeight(true))/2;b.x=g.pageX-i;b.y=g.pageY-k;b.time=new Date;if(a.isFunction(settings.hold))b.t=setTimeout("settings.hold()",settings.holdTime);a(this).mouseup(function(){b.t!=null&&clearTimeout(b.t);var j=g.pageX-i-b.x;if((new Date).getTime()-b.time.getTime()<settings.holdTime&&j<settings.threshold)if(b.x<a(this).width()/2&&a.isFunction(settings.clickLeft))settings.clickLeft();else if(b.x>=a(this).width()/2&&a.isFunction(settings.clickRight))settings.clickRight();
else a.isFunction(settings.tap)&&settings.tap();a(this).unbind("mouseup")});a(this).mousemove(function(j){a(this).mouseup(function(){a(this).unbind("mousemove")});j=j.pageX-i-b.x;if(j<=-settings.threshold){a(this).unbind("mousemove");a.isFunction(settings.dragLeft)&&settings.dragLeft()}else if(j>=settings.threshold){a(this).unbind("mousemove");a.isFunction(settings.dragRight)&&settings.dragRight()}})})});return this}})(jQuery);